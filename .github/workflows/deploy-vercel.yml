name: Deploy to Vercel

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --legacy-peer-deps
      
    - name: Type check
      run: npx tsc --noEmit
      
    - name: Lint check
      run: npm run lint
      
    - name: Build application
      run: npm run build
      env:
        NODE_ENV: production
        
    - name: Verify build output
      run: |
        echo "üîç V√©rification du build..."
        ls -la dist/
        test -f dist/index.html || (echo "‚ùå index.html manquant" && exit 1)
        test -d dist/assets || (echo "‚ùå dossier assets manquant" && exit 1)
        echo "‚úÖ Build v√©rifi√©"
        
    - name: Deploy to Vercel (Preview)
      if: github.event_name == 'pull_request'
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
        vercel-org-id: ${{ secrets.ORG_ID }}
        vercel-project-id: ${{ secrets.PROJECT_ID }}
        working-directory: ./
        scope: ${{ secrets.ORG_ID }}
        
    - name: Deploy to Vercel (Production)
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
        vercel-args: '--prod'
        vercel-org-id: ${{ secrets.ORG_ID }}
        vercel-project-id: ${{ secrets.PROJECT_ID }}
        working-directory: ./
        scope: ${{ secrets.ORG_ID }}
        
    - name: Generate and submit sitemap
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      run: |
        echo "üìç Soumission du sitemap √† Google..."
        # Attendre que le d√©ploiement soit actif
        sleep 30
        
        # Ping Google avec le sitemap
        curl -X POST "https://www.google.com/ping?sitemap=https://www.afrikoin.online/sitemap.xml" || echo "‚ö†Ô∏è Erreur ping sitemap"
        
        # Ping Bing
        curl -X POST "https://www.bing.com/ping?sitemap=https://www.afrikoin.online/sitemap.xml" || echo "‚ö†Ô∏è Erreur ping Bing"
        
    - name: Test deployed site
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      run: |
        echo "üß™ Test du site d√©ploy√©..."
        sleep 10
        
        # Test du site principal
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://www.afrikoin.online)
        if [ "$HTTP_CODE" -eq 200 ]; then
          echo "‚úÖ Site principal accessible (HTTP $HTTP_CODE)"
        else
          echo "‚ùå Site principal inaccessible (HTTP $HTTP_CODE)"
          exit 1
        fi
        
        # Test du sitemap
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://www.afrikoin.online/sitemap.xml)
        if [ "$HTTP_CODE" -eq 200 ]; then
          echo "‚úÖ Sitemap accessible (HTTP $HTTP_CODE)"
        else
          echo "‚ö†Ô∏è Sitemap inaccessible (HTTP $HTTP_CODE)"
        fi
        
        # Test du robots.txt
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://www.afrikoin.online/robots.txt)
        if [ "$HTTP_CODE" -eq 200 ]; then
          echo "‚úÖ Robots.txt accessible (HTTP $HTTP_CODE)"
        else
          echo "‚ö†Ô∏è Robots.txt inaccessible (HTTP $HTTP_CODE)"
        fi
        
    - name: Notify deployment success
      if: success() && github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      run: |
        echo "üéâ D√©ploiement Vercel r√©ussi !"
        echo "üåê Site en ligne: https://www.afrikoin.online"
        echo "üó∫Ô∏è Sitemap: https://www.afrikoin.online/sitemap.xml"
        echo "ü§ñ Robots: https://www.afrikoin.online/robots.txt"
        echo "üìä Analytics pr√™t pour l'indexation"