name: Publish Android to Google Play

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      release_notes:
        description: "Notes de version (facultatif)"
        required: false
        default: ""
      rollout_fraction:
        description: "DÃ©ploiement progressif 0â€“1 (laisser vide = 100%)"
        required: false
        default: ""

jobs:
  android-play:
    runs-on: ubuntu-latest
    name: Build AAB & Publish

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # Service de cache GitHub parfois KO â†’ on le coupe
      - name: Setup Gradle (no cache)
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-disabled: true
          add-job-summary: true

      - name: Install Android SDK (API 34 stable)
        uses: android-actions/setup-android@v3
        with:
          packages: |
            platform-tools
            platforms;android-34
            build-tools;34.0.0

      - name: Install JS deps (with fallback)
        shell: bash
        run: |
          set -e
          if ! npm ci --legacy-peer-deps --ignore-optional; then
            echo "âš ï¸ npm ci failed, trying npm installâ€¦"
            rm -rf node_modules package-lock.json || true
            npm install --legacy-peer-deps
          fi
          npm install @capacitor/core @capacitor/android --save

      - name: Ensure Android platform & sync
        shell: bash
        run: |
          if [ ! -d "android/app" ]; then
            npx cap add android || true
          fi
          npx cap sync android

      - name: Detect gradlew path
        id: gradle
        shell: bash
        run: |
          if [ -f "./gradlew" ]; then echo "dir=." >> $GITHUB_OUTPUT
          elif [ -f "./android/gradlew" ]; then echo "dir=android" >> $GITHUB_OUTPUT
          else echo "âŒ gradlew not found"; exit 1; fi

      - name: Decode Android keystore
        if: ${{ secrets.ANDROID_KEYSTORE_BASE64 != '' }}
        shell: bash
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > $HOME/release.keystore

      - name: Configure signing (Gradle)
        shell: bash
        run: |
          mkdir -p $HOME/.gradle
          {
            echo "RELEASE_STORE_FILE=$HOME/release.keystore"
            echo "RELEASE_STORE_PASSWORD=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}"
            echo "RELEASE_KEY_ALIAS=${{ secrets.ANDROID_KEY_ALIAS }}"
            echo "RELEASE_KEY_PASSWORD=${{ secrets.ANDROID_KEY_PASSWORD }}"
          } >> $HOME/.gradle/gradle.properties

      - name: Play API credentials
        shell: bash
        run: |
          echo "${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}" > $HOME/play-account.json

      - name: Build AAB (release)
        shell: bash
        run: |
          cd "${{ steps.gradle.outputs.dir }}"
          ./gradlew bundleRelease --stacktrace --info

      - name: Locate AAB & mapping
        id: locate
        shell: bash
        run: |
          cd "${{ steps.gradle.outputs.dir }}"
          AAB=$(find . -type f -path "*/outputs/bundle/*/*.aab" | head -n1)
          MAP=$(find . -type f -path "*/outputs/mapping/*/mapping.txt" | head -n1 || true)
          if [ -z "$AAB" ]; then
            echo "âŒ No AAB found"; find . -maxdepth 6 -type d -name outputs -print; exit 1
          fi
          echo "aab=$AAB" >> $GITHUB_OUTPUT
          echo "map=$MAP" >> $GITHUB_OUTPUT
          echo "Found: $AAB"; [ -n "$MAP" ] && echo "Mapping: $MAP"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release-build
          path: |
            ${{ steps.locate.outputs.aab }}
            ${{ steps.locate.outputs.map }}
          if-no-files-found: warn

      - name: Publish to Google Play (production)
        env:
          NOTES: ${{ github.event.inputs.release_notes }}
          FRACTION: ${{ github.event.inputs.rollout_fraction }}
        shell: bash
        run: |
          cd "${{ steps.gradle.outputs.dir }}"
          ARGS=(
            "-Pplay.serviceAccountCredentials=$HOME/play-account.json"
            "-Pplay.track=production"
          )
          if [ -n "$FRACTION" ]; then
            echo "ğŸŒ€ Rollout progressif: $FRACTION"
            ARGS+=("-Pplay.releaseStatus=inProgress" "-Pplay.releaseFraction=$FRACTION")
          else
            echo "ğŸš€ Rollout 100%"
            ARGS+=("-Pplay.releaseStatus=completed")
          fi
          if [ -n "$NOTES" ]; then
            echo "$NOTES" > whatsnew.txt
            ARGS+=("-Pplay.releaseNotes=en-US:whatsnew.txt")
          fi
          ./gradlew publishReleaseBundle "${ARGS[@]}" --stacktrace --info
                      - nom : Cache
  utilisationsÂ : actions/cache@v4.2.4
  avec:
    # Une liste de fichiers, de rÃ©pertoires et de modÃ¨les gÃ©nÃ©riques Ã  mettre en cache et Ã  restaurer
    chemin:
    # Une clÃ© explicite pour restaurer et sauvegarder le cache
    clÃ©:
    # Une chaÃ®ne multiligne ordonnÃ©e listant les clÃ©s correspondant au prÃ©fixe, utilisÃ©es pour restaurer le cache obsolÃ¨te si aucune correspondance n'a Ã©tÃ© trouvÃ©e pour la clÃ©. Notez que `cache-hit` renvoie false dans ce cas.
    restore-keysÂ : # facultatif
    # La taille du bloc utilisÃ© pour diviser les fichiers volumineux lors du tÃ©lÃ©chargement, en octets
    upload-chunk-sizeÂ : # facultatif
    # Un boolÃ©en facultatif lorsqu'il est activÃ©, permet aux exÃ©cuteurs Windows d'enregistrer ou de restaurer des caches qui peuvent Ãªtre restaurÃ©s ou enregistrÃ©s respectivement sur d'autres plates-formes
    enableCrossOsArchiveÂ :Â # facultatif, la valeur par dÃ©faut est false
    # Ã‰chec du flux de travail si l'entrÃ©e du cache n'est pas trouvÃ©e
    fail-on-cache-missÂ :Â # facultatif, la valeur par dÃ©faut est false
    # VÃ©rifier si une entrÃ©e de cache existe pour les entrÃ©es donnÃ©es (clÃ©, clÃ©s de restauration) sans tÃ©lÃ©charger le cache
    recherche uniquementÂ : # facultatif, la valeur par dÃ©faut est false
    # ExÃ©cutez l'Ã©tape de publication pour enregistrer le cache mÃªme si une autre Ã©tape avant Ã©choue
    save-alwaysÂ : # facultatif, la valeur par dÃ©faut est false
          
