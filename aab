@echo off
REM Configuration des variables
set AAB_FILE=ton_app.aab
set KEYSTORE=mon_keystore.jks
set ALIAS=mon_alias
set PASSWORD=motdepasse
set APKS_FILE=mon_app.apks
set APK_FILE=universal.apk
set BUNDLETOOL=bundletool.jar

REM 1. Générer un keystore si besoin
if not exist "%KEYSTORE%" (
    echo Création du keystore...
    keytool -genkeypair -v -keystore "%KEYSTORE%" -keyalg RSA -keysize 2048 -validity 10000 -alias %ALIAS% -storepass %PASSWORD% -keypass %PASSWORD% -dname "CN=Android,O=Test,C=FR"
) else (
    echo Keystore déjà présent.
)

REM 2. Générer l'APK universel
echo Conversion du .aab en .apks (APK universel)...
java -jar "%BUNDLETOOL%" build-apks ^
  --bundle="%AAB_FILE%" ^
  --output="%APKS_FILE%" ^
  --mode=universal ^
  --ks="%KEYSTORE%" ^
  --ks-key-alias=%ALIAS% ^
  --ks-pass=pass:%PASSWORD% ^
  --key-pass=pass:%PASSWORD%

REM 3. Extraire l'APK universel
echo Extraction de l'APK...
powershell -command "Expand-Archive -Force '%APKS_FILE%' ."
if exist "%APK_FILE%" (
    echo APK extrait avec succès.
) else (
    echo Extraction avec PowerShell échouée, tentative avec 7z...
    if exist "C:\Program Files\7-Zip\7z.exe" (
        "C:\Program Files\7-Zip\7z.exe" e "%APKS_FILE%" "%APK_FILE%" -aoa
    ) else (
        echo Extraction échouée. Installe 7-Zip ou extrait manuellement le fichier universal.apk du .apks.
        pause
        exit /b
    )
)

REM 4. Installer sur l'appareil Android connecté
echo Installation sur l'appareil (assure-toi qu'il est connecté en USB et en mode débogage)...
adb install -r "%APK_FILE%"

echo Fini !
pause
