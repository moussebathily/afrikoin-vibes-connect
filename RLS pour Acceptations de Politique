-- Fonction de validation pour les acceptations
CREATE OR REPLACE FUNCTION privacy.can_manage_acceptance(requesting_user_id UUID, target_user_id UUID)
RETURNS BOOLEAN AS $$
BEGIN
    RETURN 
        requesting_user_id = target_user_id OR 
        EXISTS (
            SELECT 1 
            FROM auth.users 
            WHERE id = requesting_user_id AND role = 'service_role'
        );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Politiques RLS pour les acceptations
CREATE POLICY "Users can view their own policy acceptances" 
ON privacy.policy_acceptances 
FOR SELECT 
USING (
    privacy.can_manage_acceptance(auth.uid(), user_id)
);

CREATE POLICY "Users can insert their own policy acceptances" 
ON privacy.policy_acceptances 
FOR INSERT 
WITH CHECK (
    user_id = auth.uid()
);

CREATE POLICY "Admin can manage all policy acceptances" 
ON privacy.policy_acceptances 
FOR ALL 
TO service_role
USING (true)
WITH CHECK (true);
