-- Politique pour les versions de politique
CREATE OR REPLACE FUNCTION privacy.can_view_policy_version(user_role TEXT)
RETURNS BOOLEAN AS $$
BEGIN
    RETURN user_role IN ('anon', 'authenticated', 'service_role');
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Politiques RLS détaillées
CREATE POLICY "Public policy versions visibility" 
ON privacy.policy_versions 
FOR SELECT 
TO anon, authenticated
USING (
    is_active = TRUE AND 
    privacy.can_view_policy_version(
        (SELECT role FROM auth.users WHERE id = auth.uid())
    )
);

CREATE POLICY "Admin can manage policy versions" 
ON privacy.policy_versions 
FOR ALL 
TO service_role
USING (true)
WITH CHECK (true);
