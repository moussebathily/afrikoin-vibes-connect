-- Fonction de journalisation des événements
CREATE OR REPLACE FUNCTION security.log_event(
    p_event_type TEXT, 
    p_user_id UUID DEFAULT NULL, 
    p_details JSONB DEFAULT NULL
)
RETURNS VOID AS $$
BEGIN
    INSERT INTO security.audit_log (
        event_type, 
        user_id, 
        ip_address, 
        user_agent, 
        details
    ) VALUES (
        p_event_type,
        p_user_id,
        inet_client_addr(),
        current_setting('application_name', true),
        p_details
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Fonction de vérification de consentement
CREATE OR REPLACE FUNCTION privacy.check_user_consent(
    p_user_id UUID, 
    p_consent_type TEXT
)
RETURNS BOOLEAN AS $$
BEGIN
    RETURN EXISTS (
        SELECT 1 
        FROM privacy.user_consents 
        WHERE user_id = p_user_id 
          AND consent_type = p_consent_type 
          AND is_active = TRUE
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
