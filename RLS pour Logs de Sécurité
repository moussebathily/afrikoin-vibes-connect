-- Fonction de validation pour les logs de sécurité
CREATE OR REPLACE FUNCTION security.can_view_audit_log(requesting_user_id UUID)
RETURNS BOOLEAN AS $$
BEGIN
    RETURN EXISTS (
        SELECT 1 
        FROM auth.users 
        WHERE 
            id = requesting_user_id AND 
            (
                role = 'service_role' OR 
                (app_metadata->'roles')::jsonb ? 'security_admin'
            )
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Politiques RLS pour les logs de sécurité
CREATE POLICY "Restrict audit log access" 
ON security.audit_log 
FOR SELECT 
USING (
    security.can_view_audit_log(auth.uid())
);

CREATE POLICY "Only service role can insert audit logs" 
ON security.audit_log 
FOR INSERT 
WITH CHECK (
    (SELECT role FROM auth.users WHERE id = auth.uid()) = 'service_role'
);
