// Fichier d'intÃ©gration Android Studio pour AfriKoin
// Ã€ copier dans android/app/build.gradle

apply plugin: 'com.android.application'

// Configuration automatique pour AfriKoin
def afrikoinConfig = [
    compileSdkVersion: 34,
    targetSdkVersion: 34,
    minSdkVersion: 22,
    versionCode: getVersionCode(),
    versionName: getVersionName(),
    applicationId: "com.afrikoin.app"
]

// Fonction pour obtenir le code de version automatiquement
def getVersionCode() {
    def code = project.hasProperty('VERSION_CODE') ? VERSION_CODE.toInteger() : 1
    println "ğŸ“± Version Code: $code"
    return code
}

// Fonction pour obtenir le nom de version automatiquement
def getVersionName() {
    def name = project.hasProperty('VERSION_NAME') ? VERSION_NAME : "1.0.0"
    println "ğŸ“± Version Name: $name"
    return name
}

android {
    namespace afrikoinConfig.applicationId
    compileSdk afrikoinConfig.compileSdkVersion

    defaultConfig {
        applicationId afrikoinConfig.applicationId
        minSdk afrikoinConfig.minSdkVersion
        targetSdk afrikoinConfig.targetSdkVersion
        versionCode afrikoinConfig.versionCode
        versionName afrikoinConfig.versionName
        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
        
        // Configuration pour AfriKoin
        manifestPlaceholders = [
            appName: "AfriKoin",
            appIcon: "@mipmap/ic_launcher"
        ]
    }

    // Configuration des types de build automatique
    buildTypes {
        debug {
            applicationIdSuffix ".debug"
            debuggable true
            minifyEnabled false
            shrinkResources false
            
            // Configuration de signature automatique pour debug
            signingConfig signingConfigs.debug
            
            buildConfigField "String", "BUILD_TYPE", '"debug"'
            buildConfigField "boolean", "IS_PRODUCTION", "false"
            
            println "ğŸ”§ Configuration DEBUG activÃ©e"
        }
        
        release {
            minifyEnabled true
            shrinkResources true
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
            
            // Configuration de signature automatique pour release
            if (project.hasProperty('MYAPP_RELEASE_STORE_FILE')) {
                signingConfig signingConfigs.release
            } else {
                println "âš ï¸ Pas de keystore de production configurÃ©"
            }
            
            buildConfigField "String", "BUILD_TYPE", '"release"'
            buildConfigField "boolean", "IS_PRODUCTION", "true"
            
            println "ğŸš€ Configuration RELEASE activÃ©e"
        }
    }

    // Configuration automatique des signatures
    signingConfigs {
        debug {
            storeFile file('debug.keystore')
            storePassword 'android'
            keyAlias 'androiddebugkey'
            keyPassword 'android'
        }
        
        if (project.hasProperty('MYAPP_RELEASE_STORE_FILE')) {
            release {
                storeFile file(MYAPP_RELEASE_STORE_FILE)
                storePassword MYAPP_RELEASE_STORE_PASSWORD
                keyAlias MYAPP_RELEASE_KEY_ALIAS
                keyPassword MYAPP_RELEASE_KEY_PASSWORD
            }
        }
    }

    // Configuration pour optimiser les builds
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }
    
    // Configuration pour les splits automatiques
    bundle {
        language {
            enableSplit = true
        }
        density {
            enableSplit = true
        }
        abi {
            enableSplit = true
        }
    }

    // Configuration pour les tests automatiques
    testOptions {
        unitTests.returnDefaultValues = true
        unitTests.includeAndroidResources = true
    }

    // Configuration pour amÃ©liorer les performances de build
    dexOptions {
        javaMaxHeapSize "4g"
        preDexLibraries = false
    }

    // Configuration lint automatique
    lintOptions {
        checkReleaseBuilds false
        abortOnError false
        disable 'InvalidPackage'
    }
}

// TÃ¢ches Gradle personnalisÃ©es pour AfriKoin
task buildAfrikoinDebug {
    description = 'Build automatique AfriKoin en mode debug'
    group = 'afrikoin'
    
    doLast {
        println "ğŸš€ DÃ©but du build AfriKoin Debug..."
        
        // Nettoyer avant le build
        project.tasks.clean.execute()
        
        // Assembler l'APK debug
        project.tasks.assembleDebug.execute()
        
        println "âœ… Build AfriKoin Debug terminÃ©!"
        println "ğŸ“ APK disponible dans: build/outputs/apk/debug/"
    }
}

task buildAfrikoinRelease {
    description = 'Build automatique AfriKoin en mode release (AAB)'
    group = 'afrikoin'
    
    doLast {
        println "ğŸš€ DÃ©but du build AfriKoin Release..."
        
        // VÃ©rifier la configuration de signature
        if (!project.hasProperty('MYAPP_RELEASE_STORE_FILE')) {
            throw new GradleException("âŒ Configuration de keystore manquante pour le build release")
        }
        
        // Nettoyer avant le build
        project.tasks.clean.execute()
        
        // CrÃ©er l'AAB pour le Play Store
        project.tasks.bundleRelease.execute()
        
        println "âœ… Build AfriKoin Release terminÃ©!"
        println "ğŸ“ AAB disponible dans: build/outputs/bundle/release/"
        println "ğŸš€ PrÃªt pour upload sur Google Play Store!"
    }
}

task afrikoinBuildInfo {
    description = 'Affiche les informations de build AfriKoin'
    group = 'afrikoin'
    
    doLast {
        println """
        ================================
           INFORMATIONS BUILD AFRIKOIN
        ================================
        
        ğŸ“± Application ID: ${afrikoinConfig.applicationId}
        ğŸ“Š Version Code: ${afrikoinConfig.versionCode}
        ğŸ·ï¸ Version Name: ${afrikoinConfig.versionName}
        ğŸ¯ Target SDK: ${afrikoinConfig.targetSdkVersion}
        ğŸ“¦ Min SDK: ${afrikoinConfig.minSdkVersion}
        
        ğŸ”§ TÃ¢ches disponibles:
        - ./gradlew buildAfrikoinDebug    # Build APK debug
        - ./gradlew buildAfrikoinRelease  # Build AAB release
        - ./gradlew afrikoinBuildInfo     # Afficher ces infos
        
        ================================
        """.stripIndent()
    }
}

// Automatisation post-build
gradle.taskGraph.afterTask { Task task ->
    if (task.name == 'bundleRelease') {
        println """
        ğŸ‰ AAB crÃ©Ã© avec succÃ¨s!
        
        ğŸ“ Fichier: build/outputs/bundle/release/app-release.aab
        
        ğŸš€ Prochaines Ã©tapes:
        1. Connectez-vous Ã  https://play.google.com/console
        2. SÃ©lectionnez votre app AfriKoin
        3. CrÃ©ez une nouvelle version
        4. Uploadez ce fichier AAB
        5. Publiez!
        
        """.stripIndent()
    }
    
    if (task.name == 'assembleDebug') {
        println """
        ğŸ‰ APK debug crÃ©Ã© avec succÃ¨s!
        
        ğŸ“ Fichier: build/outputs/apk/debug/app-debug.apk
        
        ğŸ“± Pour tester:
        adb install build/outputs/apk/debug/app-debug.apk
        
        """.stripIndent()
    }
}

// Configuration automatique des dÃ©pendances AfriKoin
dependencies {
    implementation 'androidx.appcompat:appcompat:1.6.1'
    implementation 'androidx.coordinatorlayout:coordinatorlayout:1.2.0'
    implementation 'androidx.core:core-splashscreen:1.0.1'
    
    // Capacitor Core
    implementation project(':capacitor-android')
    implementation project(':capacitor-haptics')
    implementation project(':capacitor-keyboard')
    implementation project(':capacitor-status-bar')
    
    // Tests automatiques
    testImplementation 'junit:junit:4.13.2'
    androidTestImplementation 'androidx.test.ext:junit:1.1.5'
    androidTestImplementation 'androidx.test.espresso:espresso-core:3.5.1'
    
    println "ğŸ“¦ DÃ©pendances AfriKoin configurÃ©es automatiquement"
}

// Configuration de proguard pour la release
android.applicationVariants.all { variant ->
    if (variant.name == 'release') {
        variant.outputs.all { output ->
            def formattedDate = new Date().format('yyyyMMdd-HHmmss')
            outputFileName = "afrikoin-${variant.versionName}-${formattedDate}.aab"
            println "ğŸ“¦ Nom de fichier AAB: $outputFileName"
        }
    }
}

println "ğŸŸ¢ Configuration Android Studio pour AfriKoin chargÃ©e avec succÃ¨s!"